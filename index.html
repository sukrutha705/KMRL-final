<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TURANG</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Manifest + icons (ensure files exist in your project root) -->
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-192.png" type="image/png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="theme-color" content="#4f46e5" />

  <!-- Service Worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>

  <style>
    :root { --shadow: 0 6px 18px rgba(15, 23, 42, 0.06); --accent: #4f46e5; }
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; color:#111827; margin:0; -webkit-font-smoothing:antialiased; }
    .container { max-width:1200px; margin:0 auto; padding:1.5rem; }
    .card { background:white; border-radius:12px; box-shadow:var(--shadow); padding:1.25rem; }
    h1,h2 { font-weight:700; }
    .table-container { overflow-x:auto; margin-top:0.5rem; }
    table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    th, td { padding:0.75rem 0.8rem; border-bottom:1px solid #e6e7eb; text-align:left; vertical-align:middle; }
    th { background:#f9fafb; font-weight:600; text-transform:uppercase; font-size:0.75rem; letter-spacing:0.06em; }
    .badge { display:inline-flex; align-items:center; padding:0.25rem 0.6rem; border-radius:9999px; font-weight:600; font-size:0.78rem; }
    .badge-green { background:#dcfcef; color:#065f46; }
    .badge-red { background:#fee2e2; color:#991b1b; }
    .light { width:12px; height:12px; border-radius:9999px; display:inline-block; margin-right:0.5rem; }
    .light-green { background:#10b981; } .light-red { background:#ef4444; }
    .spinner { border:4px solid rgba(0,0,0,0.06); width:36px; height:36px; border-radius:9999px; border-left-color:var(--accent); animation:spin 1s linear infinite; }
    @keyframes spin { from { transform:rotate(0) } to { transform:rotate(360deg) } }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; z-index:60; }
    .modal-content { background:white; padding:1.25rem; border-radius:10px; width:100%; max-width:520px; box-shadow:var(--shadow); }

    .jobDropdown { display:none; position:absolute; background:#fff; border:1px solid #e5e7eb; box-shadow:0 8px 24px rgba(15,23,42,0.06); border-radius:8px; padding:0.5rem; min-width:220px; z-index:80; }
    .jobRow { display:flex; justify-content:space-between; gap:0.5rem; padding:0.35rem 0; border-bottom:1px solid #f1f5f9; }
    .jobRow:last-child { border-bottom:none; }
    .cursor-pointer { cursor:pointer; }
    .text-blue-600 { color:#2563eb; }
    .text-red-600 { color:#dc2626; font-weight:700; }

    .brand-item { background:#f8fafc; border:1px solid #e9eef6; border-radius:10px; padding:0.9rem; margin-bottom:0.9rem; transition:transform .15s ease, box-shadow .15s ease; }
    .brand-item:hover { transform:translateY(-4px); box-shadow:0 8px 20px rgba(2,6,23,0.06); }

    @media (max-width:768px) {
      .container { padding:1rem; }
      table, thead, tbody, th, td, tr { display:block; }
      thead tr { position:absolute; left:-9999px; top:-9999px; }
      tr { border:1px solid #e6e7eb; margin-bottom:0.8rem; border-radius:8px; overflow:hidden; background:white; }
      td { border:none; border-bottom:1px solid #e6e7eb; position:relative; padding-left:50%; text-align:right; }
      td::before { position:absolute; left:12px; width:45%; padding-right:10px; white-space:nowrap; text-align:left; font-weight:600; color:#475569; content:attr(data-label); }
      .jobDropdown { position:static; width:100%; box-shadow:none; border-radius:6px; margin-top:0.5rem; }
    }
  </style>
</head>
<body>

  <!-- topbar -->
  <div class="bg-white shadow-sm">
    <div class="container flex items-center justify-between">
      <div class="flex items-center gap-4 py-3">
        <h1 class="text-lg">AI-Driven Train Induction Planning</h1>
        <button id="openManualModalBtn" class="px-3 py-1 bg-indigo-600 text-white rounded-md text-sm">Manual Entry</button>
        <button id="adsLink" class="px-3 py-1 bg-gray-100 rounded-md text-sm">Advertisement Mgmt</button>
      </div>
      <div class="flex items-center gap-3">
        <button id="langToggle" class="px-3 py-1 bg-gray-100 rounded-md text-sm">ML / EN</button>
        <a id="installPrompt" class="px-3 py-1 bg-gray-100 rounded-md text-sm hidden">Install</a>
      </div>
    </div>
  </div>

  <!-- main dashboard -->
  <main id="dashboard" class="container mt-6">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <section class="card">
        <h2 class="text-2xl font-bold mb-3 flex items-center"><span class="light light-green"></span><span id="eligibleHeader">Revenue Service Pool</span></h2>
        <div class="table-container" id="eligibleTrains">
          <div id="eligibleLoading" class="flex items-center justify-center h-48"><div class="spinner"></div></div>
          <div class="overflow-x-auto w-full">
            <table id="eligibleTrainsTable" class="hidden">
              <thead><tr id="eligibleHeadRow"></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="text-2xl font-bold mb-3 flex items-center"><span class="light light-red"></span><span id="ineligibleHeader">Maintenance & Standby Pool</span></h2>
        <div class="table-container" id="ineligibleTrains">
          <div id="ineligibleLoading" class="flex items-center justify-center h-48"><div class="spinner"></div></div>
          <div class="overflow-x-auto w-full">
            <table id="ineligibleTrainsTable" class="hidden">
              <thead><tr id="ineligibleHeadRow"></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <!-- confirm modal -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <p id="confirmMessage" class="mb-4 text-lg font-semibold"></p>
        <div class="flex justify-center gap-3">
          <button id="confirmYes" class="px-4 py-2 bg-green-500 text-white rounded-md">Yes</button>
          <button id="confirmNo" class="px-4 py-2 bg-gray-300 rounded-md">No</button>
        </div>
      </div>
    </div>

    <!-- manual modal -->
    <div id="manualModal" class="modal">
      <div class="modal-content">
        <h2 id="manualModalTitle" class="text-xl font-bold mb-3">Manual Data Entry</h2>

        <div class="grid grid-cols-1 gap-3">
          <div>
            <label id="labelTrainId" class="block text-sm font-semibold">Train ID</label>
            <input id="manualTrainId" type="text" placeholder="e.g., T101" class="mt-1 block w-full rounded-md border p-2" />
          </div>
          <div>
            <label id="labelJobCards" class="block text-sm font-semibold">Job Cards</label>
            <input id="manualJobCards" type="number" placeholder="Number of open jobs" class="mt-1 block w-full rounded-md border p-2" />
          </div>
          <div>
            <label id="labelMileage" class="block text-sm font-semibold">Mileage</label>
            <input id="manualMileage" type="number" placeholder="Enter mileage" class="mt-1 block w-full rounded-md border p-2" />
          </div>
          <div>
            <label id="labelFitnessCert" class="block text-sm font-semibold">Fitness Certificate</label>
            <select id="manualFitnessCertificate" class="mt-1 block w-full rounded-md border p-2">
              <option value="true">True</option>
              <option value="false">False</option>
            </select>
          </div>
          <div>
            <label id="labelCleaning" class="block text-sm font-semibold">Cleaning Status</label>
            <select id="manualCleaningStatus" class="mt-1 block w-full rounded-md border p-2">
              <option value="Done">Done</option>
              <option value="Not Done">Not Done</option>
            </select>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-4">
          <button id="manualCancel" class="px-4 py-2 bg-gray-300 rounded-md">Cancel</button>
          <button id="manualSubmit" class="px-4 py-2 bg-green-600 text-white rounded-md">Save</button>
        </div>
      </div>
    </div>
  </main>

  <!-- advertisements page -->
  <section id="advertisementsPage" class="hidden">
    <div class="container mt-6">
      <button id="backButton" class="px-3 py-1 bg-gray-200 rounded-md">Back to Dashboard</button>
      <h1 id="adsHeader" class="text-2xl font-semibold mt-4 mb-4">Advertisement Management</h1>
      <div id="progress-list"></div>
    </div>
  </section>

  <!-- script: dynamic logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // Supabase credentials (from your earlier file)
    const SUPABASE_URL = "https://nquzhbqkdwwxqmkdwjuz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xdXpoYnFrZHd3eHFta2R3anV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzAxOTcsImV4cCI6MjA3MzAwNjE5N30.zCys6_cd9vvsK2Sr-xBsT_ZXYRRIm9iH1opekRvSATA";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // translations
    const translations = {
      en: {
        eligiblePool: "Revenue Service Pool",
        ineligiblePool: "Maintenance & Standby Pool",
        trainNo: "Train #",
        eligibility: "Service Eligibility",
        branding: "Branding",
        mileage: "Mileage",
        jobs: "Jobs Open/Total",
        action: "Action",
        reason: "Reason",
        ready: "Ready",
        send: "Send",
        makeReady: "Make Ready",
        confirmSend: t => `Are you sure you want to send Train ${t} to Revenue Service?`,
        confirmMakeReady: t => `Are you sure you want to make Train ${t} ready?`,
        missingCert: "Missing Fitness Cert",
        criticalJob: "Critical Job Open",
        tooManyJobs: "Too Many Jobs",
        inService: "In Revenue Service",
        manualTitle: "Manual Data Entry",
        labelTrainId: "Train ID",
        labelJobCards: "Job Cards",
        labelMileage: "Mileage",
        labelFitnessCert: "Fitness Certificate",
        labelCleaning: "Cleaning",
        optionOpen: "True",
        optionClose: "False",
        optionDone: "Done",
        optionNotDone: "Not Done",
        optionCompleted: "Completed",
        optionPending: "Pending",
        cancel: "Cancel",
        save: "Save",
        adsHeader: "Advertisement Management",
      },
      ml: {
        eligiblePool: "വരുമാന സേവന പൂൾ",
        ineligiblePool: "പരിചരണവും സ്റ്റാൻഡ്ബൈ പൂളും",
        trainNo: "ട്രെയിൻ #",
        eligibility: "സേവന യോഗ്യത",
        branding: "ബ്രാൻഡിംഗ്",
        mileage: "മൈലേജ്",
        jobs: "ജോബുകൾ തുറന്നത്/ആകെ",
        action: "പ്രവർത്തി",
        reason: "കാരണം",
        ready: "തയ്യാർ",
        send: "അയക്കുക",
        makeReady: "തയ്യാറാക്കുക",
        confirmSend: t => `ട്രെയിൻ ${t} വരുമാന സേവനത്തിലേക്ക് അയയ്ക്കാൻ നിങ്ങൾ ആഗ്രഹിക്കുന്നുണ്ടോ?`,
        confirmMakeReady: t => `ട്രെയിൻ ${t} തയ്യാറാക്കാൻ നിങ്ങൾ ആഗ്രഹിക്കുന്നുണ്ടോ?`,
        missingCert: "ഫിറ്റ്നസ് സർട്ടിഫിക്കറ്റ് ഇല്ല",
        criticalJob: "ഗുരുതരമായ ജോബ് തുറന്നിരിക്കുന്നു",
        tooManyJobs: "വളരെ അധികം ജോബുകൾ",
        inService: "വരുമാന സേവനത്തിൽ",
        manualTitle: "മാനുവൽ ഡാറ്റ എൻട്രി",
        labelTrainId: "ട്രെയിൻ ID",
        labelJobCards: "ജോബുകൾ",
        labelMileage: "മൈലേജ്",
        labelFitnessCert: "ഫിറ്റ്നസ് സർട്ടിഫിക്കറ്റ്",
        labelCleaning: "ക്ലീനിംഗ്",
        optionOpen: "ശരിയാണ്",
        optionClose: "അല്ല",
        optionDone: "പൂർത്തിയായി",
        optionNotDone: "പൂർത്തിയായില്ല",
        optionCompleted: "പൂർത്തിയായി",
        optionPending: "തീർച്ചപ്പെടുത്തിയിട്ടില്ല",
        cancel: "റദ്ദാക്കുക",
        save: "സേവ്",
        adsHeader: "പരസ്യം മാനേജ്മെൻ്റ്",
        brands: {
          "KMRL Standard": "കൊച്ചി മെട്രോ സ്റ്റാൻഡേർഡ്",
          "Jio": "ജിയോ",
          "HDFC Bank": "എച്ച്ഡിഎഫ്\u200cസി ബാങ്ക്",
          "Maruti Suzuki": "മാരുതി സുസുക്കി",
          "Dabur": "ഡാബർ",
          "Samsung": "സാംസങ്",
          "Myntra": "മിന്ത്ര",
          "Amazon": "ആമസോൺ"
        }
      }
    };

    let currentLang = 'en';
    let allTrainData = [];

    // UI elements
    const dashboard = document.getElementById('dashboard');
    const advertisementsPage = document.getElementById('advertisementsPage');
    const adsLink = document.getElementById('adsLink');
    const backButton = document.getElementById('backButton');
    const langToggle = document.getElementById('langToggle');
    const openManualModalBtn = document.getElementById('openManualModalBtn');
    const manualModal = document.getElementById('manualModal');
    const manualCancel = document.getElementById('manualCancel');
    const manualSubmit = document.getElementById('manualSubmit');
    const eligibleLoading = document.getElementById('eligibleLoading');
    const ineligibleLoading = document.getElementById('ineligibleLoading');

    // Confirm modal
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    let pendingAction = null;
    let pendingTrainId = null;

    // Branding list for ads demo
    const BRANDING_TYPES = ["KMRL Standard","Jio","HDFC Bank","Maruti Suzuki","Dabur","Samsung","Myntra","Amazon"];

    // Document-fragment batch render helper
    function batchRender(nodes, container) {
      const frag = document.createDocumentFragment();
      nodes.forEach(n => frag.appendChild(n));
      container.appendChild(frag);
    }

    // Toggle job dropdown (global)
    window.toggleJobsDropdown = function(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    };

    // show confirm modal
    function showConfirm(msg, trainId, action) {
      confirmMessage.textContent = msg;
      confirmModal.style.display = 'flex';
      pendingTrainId = trainId;
      pendingAction = action;
    }

    confirmNo.addEventListener('click', () => {
      confirmModal.style.display = 'none';
      pendingAction = null; pendingTrainId = null;
    });

    confirmYes.addEventListener('click', async () => {
      if (!pendingTrainId || !pendingAction) { confirmModal.style.display = 'none'; return; }
      try {
        if (pendingAction === 'send') {
          await supabase.from('trains').update({ inService: true }).eq('train_id', pendingTrainId);
        } else if (pendingAction === 'makeReady') {
          // Example: mark not inService; real logic can vary
          await supabase.from('trains').update({ inService: false }).eq('train_id', pendingTrainId);
        }
      } catch (err) {
        console.error('Supabase update error', err);
      }
      await fetchAllTrainData();
      confirmModal.style.display = 'none';
      pendingTrainId = null; pendingAction = null;
    });

    // Attach action buttons to a row: NOTE: we'll use this selectively so eligible only gets "Send"
    function makeSendButton(trainId) {
      const sendBtn = document.createElement('button');
      sendBtn.className = 'px-2 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700';
      sendBtn.textContent = translations[currentLang].send;
      sendBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        showConfirm(translations[currentLang].confirmSend(trainId), trainId, 'send');
      });
      return sendBtn;
    }

    function makeMakeReadyButton(trainId) {
      const readyBtn = document.createElement('button');
      readyBtn.className = 'px-2 py-1 bg-green-600 text-white rounded-md text-sm hover:bg-green-700';
      readyBtn.textContent = translations[currentLang].makeReady;
      readyBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        showConfirm(translations[currentLang].confirmMakeReady(trainId), trainId, 'makeReady');
      });
      return readyBtn;
    }

    // Render tables (eligible only Send; ineligible only Make Ready)
    function renderTables(eligible, ineligible) {
      const eligibleBody = document.querySelector('#eligibleTrainsTable tbody');
      const ineligibleBody = document.querySelector('#ineligibleTrainsTable tbody');

      eligibleBody.innerHTML = '';
      ineligibleBody.innerHTML = '';

      // headers
      document.getElementById('eligibleHeadRow').innerHTML =
        `<th class="text-center">${translations[currentLang].trainNo}</th>
         <th class="text-center">${translations[currentLang].eligibility}</th>
         <th class="text-center">${translations[currentLang].branding}</th>
         <th class="text-center">${translations[currentLang].mileage}</th>
         <th class="text-center">${translations[currentLang].jobs}</th>
         <th class="text-center">${translations[currentLang].action}</th>`;

      document.getElementById('ineligibleHeadRow').innerHTML =
        `<th class="text-center">${translations[currentLang].trainNo}</th>
         <th class="text-center">${translations[currentLang].reason}</th>
         <th class="text-center">${translations[currentLang].branding}</th>
         <th class="text-center">${translations[currentLang].mileage}</th>
         <th class="text-center">${translations[currentLang].jobs}</th>
         <th class="text-center">${translations[currentLang].action}</th>`;

      // create eligible nodes (only Send button)
      const eligibleNodes = eligible.map(train => {
        const tr = document.createElement('tr');
        tr.className = 'relative';

        const openCount = (train.jobCards || []).filter(j => j.status === 'Open' || j.status === 'open').length;
        const jobListHtml = (train.jobCards || []).map(j => `<div class="jobRow"><span>${j.name || j.title || 'Job'}</span><span class="${j.isCritical ? 'text-red-600' : ''}">${j.isCritical ? '⚠' : ''}</span></div>`).join('');

        tr.innerHTML = `
          <td data-label="${translations[currentLang].trainNo}">${train.train_id}</td>
          <td data-label="${translations[currentLang].eligibility}"><span class="badge badge-green">✅</span></td>
          <td data-label="${translations[currentLang].branding}" class="relative">
            <div class="font-semibold">${(currentLang === 'ml' && translations.ml.brands && translations.ml.brands[train.branding]) ? translations.ml.brands[train.branding] : (train.branding || 'N/A')}</div>
            <div class="jobDropdown">${jobListHtml || '<div class="jobRow"><span>No jobs</span></div>'}</div>
          </td>
          <td data-label="${translations[currentLang].mileage}">${train.mileage || 0}</td>
          <td data-label="${translations[currentLang].jobs}" class="relative cursor-pointer text-blue-600 hover:underline" onclick="toggleJobsDropdown('${train.train_id}-eligible')">
            <span class="font-semibold">${openCount} / ${ (train.jobCards||[]).length }</span>
            <div id="${train.train_id}-eligible" class="jobDropdown">${jobListHtml || '<div class="jobRow"><span>No jobs</span></div>'}</div>
          </td>`;

        // action td (only Send)
        const tdAction = document.createElement('td');
        tdAction.setAttribute('data-label', translations[currentLang].action);
        tdAction.className = 'text-right';
        tdAction.appendChild(makeSendButton(train.train_id));
        tr.appendChild(tdAction);

        return tr;
      });

      // create ineligible nodes (only Make Ready button)
      const ineligibleNodes = ineligible.map(train => {
        const tr = document.createElement('tr');
        tr.className = 'relative';
        const openCount = (train.jobCards || []).filter(j => j.status === 'Open' || j.status === 'open').length;
        const jobListHtml = (train.jobCards || []).map(j => `<div class="jobRow"><span>${j.name || j.title || 'Job'}</span><span class="${j.isCritical ? 'text-red-600' : ''}">${j.isCritical ? '⚠' : ''}</span></div>`).join('');

        tr.innerHTML = `
          <td data-label="${translations[currentLang].trainNo}">${train.train_id}</td>
          <td data-label="${translations[currentLang].reason}">${train.ineligibleReasons.join(', ') || '-'}</td>
          <td data-label="${translations[currentLang].branding}" class="relative">
            <div class="font-semibold">${(currentLang === 'ml' && translations.ml.brands && translations.ml.brands[train.branding]) ? translations.ml.brands[train.branding] : (train.branding || 'N/A')}</div>
            <div class="jobDropdown">${jobListHtml || '<div class="jobRow"><span>No jobs</span></div>'}</div>
          </td>
          <td data-label="${translations[currentLang].mileage}">${train.mileage || 0}</td>
          <td data-label="${translations[currentLang].jobs}" class="relative cursor-pointer text-blue-600 hover:underline" onclick="toggleJobsDropdown('${train.train_id}-ineligible')">
            <span class="font-semibold">${openCount} / ${ (train.jobCards||[]).length }</span>
            <div id="${train.train_id}-ineligible" class="jobDropdown">${jobListHtml || '<div class="jobRow"><span>No jobs</span></div>'}</div>
          </td>`;

        const tdAction = document.createElement('td');
        tdAction.setAttribute('data-label', translations[currentLang].action);
        tdAction.className = 'text-right';
        tdAction.appendChild(makeMakeReadyButton(train.train_id));
        tr.appendChild(tdAction);

        return tr;
      });

      batchRender(eligibleNodes, eligibleBody);
      batchRender(ineligibleNodes, ineligibleBody);

      // hide loaders and reveal tables
      eligibleLoading.classList.add('hidden');
      ineligibleLoading.classList.add('hidden');
      document.getElementById('eligibleTrainsTable').classList.remove('hidden');
      document.getElementById('ineligibleTrainsTable').classList.remove('hidden');
    }

    // Process data -> determine eligible / ineligible
    function processTrainData(data) {
      const t = translations[currentLang];
      const processed = (data || []).map(train => {
        const reasons = [];
        if (!train.fitnessCertificate) reasons.push(t.missingCert);
        if ((train.jobCards || []).some(j => j.isCritical && (j.status === 'Open' || j.status === 'open'))) reasons.push(t.criticalJob);
        if ((train.jobCards || []).filter(j => (j.status === 'Open' || j.status === 'open')).length > 3) reasons.push(t.tooManyJobs);
        if (train.inService) reasons.push(t.inService);
        return { ...train, ineligibleReasons: reasons };
      });

      const eligible = processed.filter(x => x.ineligibleReasons.length === 0);
      const ineligible = processed.filter(x => x.ineligibleReasons.length > 0);
      renderTables(eligible, ineligible);
    }

    // fallback sample data (used when Supabase unavailable)
    function getFallbackData() {
      return [
        { train_id: "T112", mileage: 2233, fitnessCertificate: true, cleaningStatus: "Completed", branding: "KMRL Standard", jobCards: [{ id:1, name:"Brake System Inspection", status:"Open", isCritical:false },{ id:2, name:"Door Mechanism Check", status:"Open", isCritical:false },{ id:3, name:"AC Filter Change", status:"Closed", isCritical:false }] },
        { train_id: "T123", mileage: 6922, fitnessCertificate: true, cleaningStatus: "Completed", branding: "Jio", jobCards: [{ id:1, name:"Pantograph Service", status:"Open", isCritical:false }] },
        { train_id: "T124", mileage: 9021, fitnessCertificate: true, cleaningStatus: "Completed", branding: "HDFC Bank", jobCards: [{ id:1, name:"Annual Fitness Certification", status:"Open", isCritical:true },{ id:8, name:"Interior Cleaning", status:"Open", isCritical:false }] },
        { train_id: "T101", mileage: 6488, fitnessCertificate: true, cleaningStatus: "Pending", branding: "KMRL Standard", jobCards: [{ id:1, name:"Interior Deep Cleaning", status:"Open", isCritical:false }] },
        { train_id: "T110", mileage: 25000, fitnessCertificate: false, cleaningStatus: "Completed", branding: "KMRL Standard", jobCards: [] },
        { train_id: "T125", mileage: 12000, fitnessCertificate: true, cleaningStatus: "Completed", branding: "Dabur", jobCards: [{ id:1, name:"Wheel Profile Measurement", status:"Open", isCritical:false }] }
      ];
    }

    // fetch trains from supabase (with fallback)
    async function fetchAllTrainData() {
      try {
        const { data, error } = await supabase.from('trains').select('*');
        if (error) {
          console.error('Supabase error', error);
          allTrainData = getFallbackData();
        } else {
          allTrainData = (data || []).map(t => ({ ...t, jobCards: t.jobCards || [] }));
        }
      } catch (err) {
        console.error('Fetch error', err);
        allTrainData = getFallbackData();
      }

      processTrainData(allTrainData);
    }

    // Update manual modal labels (translation-aware)
    function updateManualModalLabels() {
      const t = translations[currentLang];
      document.getElementById('manualModalTitle').textContent = t.manualTitle;
      document.getElementById('labelTrainId').textContent = t.labelTrainId;
      document.getElementById('labelJobCards').textContent = t.labelJobCards;
      document.getElementById('labelMileage').textContent = t.labelMileage;
      document.getElementById('labelFitnessCert').textContent = t.labelFitnessCert;
      document.getElementById('labelCleaning').textContent = t.labelCleaning;
      const fs = document.getElementById('manualFitnessCertificate');
      fs.options[0].text = t.optionOpen; fs.options[1].text = t.optionClose;
      const cs = document.getElementById('manualCleaningStatus');
      cs.options[0].text = t.optionDone; cs.options[1].text = t.optionNotDone;
      document.getElementById('manualCancel').textContent = t.cancel;
      document.getElementById('manualSubmit').textContent = t.save;
    }

    // Update dashboard text & headers
    function updateDashboardText() {
      const t = translations[currentLang];
      document.getElementById('eligibleHeader').textContent = t.eligiblePool;
      document.getElementById('ineligibleHeader').textContent = t.ineligiblePool;
      document.getElementById('adsHeader').textContent = t.adsHeader;
      updateManualModalLabels();
      if (allTrainData && allTrainData.length) processTrainData(allTrainData);
    }

    // Render advertisement bars
    function renderProgressBars() {
      const list = document.getElementById('progress-list');
      list.innerHTML = '';
      BRANDING_TYPES.forEach(name => {
        const total = Math.floor(Math.random() * 500) + 100;
        const completed = Math.floor(Math.random() * total);
        const percent = Math.round((completed / total) * 100);

        const div = document.createElement('div');
        div.className = 'brand-item';
        div.innerHTML = `
          <div class="brand-info flex items-baseline justify-between mb-2">
            <div class="brand-name font-semibold">${(currentLang==='ml' && translations.ml.brands && translations.ml.brands[name]) ? translations.ml.brands[name] : name}</div>
            <div class="brand-hours text-sm text-slate-500">${completed} / ${total} hours</div>
          </div>
          <div class="progress-container w-full bg-slate-100 rounded-full h-4 overflow-hidden">
            <div class="progress-bar h-4 rounded-full" style="width:${percent}%; background:var(--accent);"></div>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // UI event wiring
    adsLink.addEventListener('click', () => {
      dashboard.classList.add('hidden');
      advertisementsPage.classList.remove('hidden');
      renderProgressBars();
    });
    backButton.addEventListener('click', () => {
      advertisementsPage.classList.add('hidden');
      dashboard.classList.remove('hidden');
      updateDashboardText();
    });

    langToggle.addEventListener('click', () => {
      currentLang = (currentLang === 'en') ? 'ml' : 'en';
      updateDashboardText();
      if (!advertisementsPage.classList.contains('hidden')) renderProgressBars();
    });

    openManualModalBtn.addEventListener('click', () => {
      document.getElementById('manualTrainId').value = '';
      document.getElementById('manualJobCards').value = '';
      document.getElementById('manualMileage').value = '';
      document.getElementById('manualFitnessCertificate').value = 'true';
      document.getElementById('manualCleaningStatus').value = 'Done';
      updateManualModalLabels();
      manualModal.style.display = 'flex';
    });
    manualCancel.addEventListener('click', () => manualModal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target === manualModal) manualModal.style.display = 'none'; });

    // Manual submit handler (inserts/updates supabase)
    document.getElementById('manualSubmit').addEventListener('click', async () => {
      const trainId = document.getElementById('manualTrainId').value.trim().toUpperCase();
      const jobCardsCount = parseInt(document.getElementById('manualJobCards').value || '0', 10);
      const mileage = parseInt(document.getElementById('manualMileage').value || '0', 10);
      const fitness = (document.getElementById('manualFitnessCertificate').value === 'true');
      const cleaning = document.getElementById('manualCleaningStatus').value;

      if (!trainId) { alert('Please enter Train ID'); return; }

      const defaultJobNames = [
        "Brake System Inspection","Door Mechanism Check","Air Conditioning Test","Pantograph Inspection",
        "Wheel Profile Measurement","Traction System Health Check","Suspension Inspection","Interior Deep Cleaning",
        "Exterior Wash","Seat & Upholstery Sanitization","Driver Cabin Sanitization","Traction Motor Replacement",
        "Battery Pack Change","HVAC Filter Replacement","Coupler Repair","Brake Pad Replacement","Lighting System Repair",
        "Fire Extinguisher Check","Emergency Lighting Test","Annual Fitness Certification","First Aid Kit Replenishment",
        "Onboard CCTV Firmware Update","Passenger Information System Reset","Driver Console Calibration","Speed Sensor Recalibration"
      ];

      const jobCards = Array.from({ length: jobCardsCount }, (_, i) => ({
        id: i+1,
        name: defaultJobNames[i % defaultJobNames.length],
        status: 'Open',
        isCritical: i === 0
      }));

      try {
        await supabase.from('trains').upsert({
          train_id: trainId,
          jobCards,
          mileage,
          fitnessCertificate: fitness,
          cleaningStatus: cleaning
        }, { onConflict: 'train_id' });
      } catch (err) {
        console.error('Supabase upsert error', err);
      }

      manualModal.style.display = 'none';
      await fetchAllTrainData();
    });

    // initial load
    (async function init() {
      eligibleLoading.classList.remove('hidden');
      ineligibleLoading.classList.remove('hidden');
      await fetchAllTrainData();
      updateDashboardText();
    })();
  </script>
</body>
</html>

